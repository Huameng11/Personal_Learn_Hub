# 树莓派学习笔记

## 一、树莓派简介

树莓派（Raspberry Pi）是一款基于ARM架构的单板计算机，由英国树莓派基金会开发，旨在促进计算机科学教育。虽然体积小巧（仅信用卡大小），但具备完整计算机功能，可运行Linux等操作系统。

**主要特点：**

- •低功耗、低成本
- •GPIO接口支持电子项目开发
- •丰富的社区支持和生态系统
- •适合学习编程、物联网项目、家庭服务器等场景

使用的是**树莓派4B**型号，配备4GB内存，搭载64位四核Cortex-A72处理器，运行Raspberry Pi OS（基于Debian）。

## 二、树莓派系统烧录

### 1. 下载系统镜像

- •官方下载地址：https://www.raspberrypi.com/software/
- •推荐使用**Raspberry Pi Imager**工具进行烧录
- •选择带桌面的64位系统镜像
- 手动下载镜像地址
- https://www.raspberrypi.com/software/operating-systems/

### 2. 烧录步骤（SSD启动）

1. 将MicroSD卡插入读卡器并连接电脑
2. 打开Raspberry Pi Imager工具
3. 选择操作系统 → misc utility images---bootloader----usb Boot
4. 选择存储卡目标,点击烧录即可
5. 存储卡插入树莓派启动，自动设置为USB-Boot启动
6. SSD硬盘插入电脑，按以上步骤烧录Raspberry Pi OS (64-bit)系统，编辑配置设置wifi，ssh，WiFi地区选择CN
7. ssd插入树莓派即可启动，SSH按ip连接

## 三、一键获取系统硬件信息脚本

创建一个脚本文件：

```bash
nano system_report.sh
```

将以下内容复制粘贴到文件中：

```bash
#!/bin/bash

REPORT_FILE="/home/pi/pi_system_report_$(date +%Y%m%d_%H%M%S).txt"

{
    echo "===================== 树莓派系统全面配置报告 ====================="
    echo "生成时间: $(date)"
    echo "=================================================================="
    echo ""
    echo "---------------------- 1. 核心系统与硬件信息 ----------------------"
    echo ">> OS 版本:"
    cat /etc/os-release
    echo ""
    echo ">> 内核版本:"
    uname -a
    echo ""
    echo ">> 主机名:"
    hostname
    echo ""
    echo ">> 运行时间:"
    uptime
    echo ""
    echo ">> CPU 信息:"
    lscpu
    echo ""
    echo ">> ARM 频率和温度:"
    vcgencmd measure_clock arm
    vcgencmd measure_temp
    echo ""
    echo ">> 内存信息:"
    free -h
    echo ""
    echo ">> 磁盘使用:"
    df -h
    echo ""
    echo ">> GPU 内存:"
    vcgencmd get_mem gpu
    echo ""

    echo "---------------------- 2. 网络配置 ----------------------"
    echo ">> IP 地址:"
    hostname -I
    echo ""
    echo ">> 网络接口:"
    ip addr show
    echo ""
    echo ">> DNS 配置:"
    cat /etc/resolv.conf
    echo ""
    echo ">> 路由表:"
    ip route
    echo ""

    echo "---------------------- 3. 系统设置 ----------------------"
    echo ">> 环境变量:"
    printenv
    echo ""
    echo ">> 时区:"
    timedatectl status
    echo ""
    echo ">> 区域设置:"
    locale
    echo ""

    echo "---------------------- 4. 硬件与树莓派特定设置 ----------------------"
    echo ">> USB 设备:"
    lsusb
    echo ""
    echo ">> Config.txt 生效的配置 (数字):"
    vcgencmd get_config int
    echo ""
    echo ">> Config.txt 生效的配置 (字符串):"
    vcgencmd get_config str
    echo ""
    echo ">> 摄像头状态:"
    vcgencmd get_camera
    echo ""
    echo ">> 显示信息:"
    tvservice -s
    echo ""

} > "$REPORT_FILE"

echo "系统报告已生成至: $REPORT_FILE"
```

保存并退出（按 `Ctrl+X`, 然后 `Y`, 然后 `Enter`）。

给脚本添加执行权限并运行它：

**使用方法：**

```
chmod +x system_report.sh
./system_report.sh
```

脚本会在您的家目录（`/home/pi/`）下生成一个名为 `pi_system_report_日期时间.txt` 的文件，里面包含了您当前树莓派几乎所有的重要设置。

## 四、当前树莓派基本配置

### 硬件配置：

- •**型号**：Raspberry Pi 4 Model B Rev 1.5
- •**CPU**：4核Cortex-A72 @ 1.8GHz
- •**内存**：8GB LPDDR4
- •**存储**：外接SSD（470GB容量）
- •**系统**：Raspberry Pi OS 64-bit (Debian 12)

### 网络配置：

- •**主机名**：raspberrypi
- •**IP地址**：192.168.124.8（王村路由器）
- •**用户名**：pi
- •**密码**：已修改为安全密码

## 五、基础命令学习

### 1. 系统信息命令

```
hostname -I      # 查看IP地址
uname -a         # 查看系统信息
vcgencmd measure_temp  # 查看CPU温度
df -h            # 查看磁盘空间
lsblk			#查看挂载硬盘
free -h          # 查看内存使用
sudo ss -tulnp #查看端口信息
```

### 2. 文件操作命令

```
ls               # 列出文件
cd               # 切换目录
cd ~ #回到home
pwd              # 显示当前目录
mkdir            # 创建目录
rm               # 删除文件
cp               # 复制文件
mv               # 移动文件
nano             # 文本编辑
```

### 3. 网络管理命令

```
ping             # 测试网络连通性
ip addr          # 查看网络接口
nmcli            # NetworkManager命令行工具
```

### 4. 权限管理命令

```
sudo             # 超级用户权限
chmod            # 修改文件权限
chown            # 修改文件所有者
```

### 5. 进程管理命令

```
ps aux           # 查看所有进程
top              # 动态查看进程
htop             # 增强版top（需安装）
kill             # 终止进程
```

### 6. 包管理命令

```
sudo apt update          # 更新软件列表
sudo apt upgrade         # 升级所有软件
sudo apt install [软件包] # 安装软件
sudo apt remove [软件包]  # 卸载软件
```

### 7.Docker命令

```bash
#查看运行情况
docker ps
#查看指定容器的最近日志
docker logs <容器名或ID>
#查看 x-ui 容器的日志（假设容器名为 x-ui）
docker logs x-ui
#实时查看日志（类似 tail -f）
docker logs -f x-ui
#docker-compose启动
docker-compose up -d
#docker-compose停止
docker-compose down
```

## 六、基础服务安装

### 1. 设置临时网络代理

```
export http_proxy="http://192.168.124.23:10811"
export https_proxy="http://192.168.124.23:10811"
```

### 2. 系统更新

```
sudo apt update
sudo apt upgrade -y
sudo apt install -y wget curl git
```

### 3. Docker安装

```
# 安装Docker
sudo apt install docker.io -y
sudo systemctl enable --now docker

# 将用户添加到docker组
sudo usermod -aG docker pi

# 注意：重新登录使更改生效
```

### 4. 独立Docker Compose安装

```
# 下载Docker Compose
sudo curl -L "https://github.com/docker/compose/releases/download/v2.27.1/docker-compose-$(uname -s)-$(uname -m)" -o /usr/local/bin/docker-compose

# 添加执行权限
sudo chmod +x /usr/local/bin/docker-compose

# 验证安装
docker-compose --version
```

如果最后一条命令输出了版本号（如 `Docker Compose version v2.27.1`），说明安装成功。

### 5. Docker代理配置

```
# 创建配置目录
sudo mkdir -p /etc/systemd/system/docker.service.d

# 创建代理配置文件
sudo nano /etc/systemd/system/docker.service.d/http-proxy.conf
```

添加以下内容：

```
[Service]
Environment="HTTP_PROXY=http://192.168.31.109:10811/"
Environment="HTTPS_PROXY=http://192.168.31.109:10811/"
Environment="NO_PROXY=localhost,127.0.0.1,*.lan"
```

**保存并退出** 按 `Ctrl + X`，然后按 `Y`，再按 `Enter`。

重载配置并重启Docker：

```
sudo systemctl daemon-reload
sudo systemctl restart docker
```

### 6.预添加新WiFi网络的步骤

我们将直接在存放网络配置的目录中，创建一个新的文件来定义这个未来的网络。

1. **进入NetworkManager的配置目录** 这个目录存放着所有已知的网络连接。

   ```Bash
   cd /etc/NetworkManager/system-connections/
   ```

2. **创建一个新的连接配置文件** 我们需要使用 `sudo` 因为这个目录属于 `root` 用户。请将命令中的 `新WiFi名称` 替换为您未来要连接的那个WiFi的真实名称（SSID），这样方便您自己识别。

   ```Bash
   # 例如，如果新WiFi名叫"Office-WiFi", 就设置为 "sudo nano Office-WiFi.nmconnection"
   sudo nano "新WiFi名称.nmconnection"
   ```

3. **写入新WiFi的配置信息** 将下面的**模板内容完整地复制**并粘贴到您刚刚打开的 `nano` 编辑器中。

   ```Bash
   [connection]
   id=您新WiFi的名称
   uuid=
   type=wifi
   interface-name=wlan0
   
   [wifi]
   mode=infrastructure
   ssid=您新WiFi的名称
   
   [wifi-security]
   key-mgmt=wpa-psk
   psk=您新WiFi的密码
   
   [ipv4]
   method=auto
   
   [ipv6]
   method=auto
   ```

4. **修改模板中的关键信息** 您需要编辑上面模板中的**三处**地方：

   - `id=` 后面：填入您新WiFi的名称（SSID），例如 `id=Office-WiFi`。
   - `ssid=` 后面：再次填入您新WiFi的名称，例如 `ssid=Office-WiFi`。
   - `psk=` 后面：填入您新WiFi的**明文密码**，例如 `psk=Password12345`。
   - `uuid=` 后面**留空**。当NetworkManager第一次加载这个文件时，会自动为您生成一个唯一的UUID并填充进去。

5. **保存并退出**

   - 按 `Ctrl+X`
   - 按 `Y` 确认保存
   - 按 `Enter` 确认文件名并退出

## 七、应用服务安装

### 1. x-ui面板安装（网络代理服务）（Docker部署）

分为两个主要部分：**服务端部署 (x-ui)** 和 **web端配置 节点链接**

1. **x-ui 服务端面板**：将树莓派作为代理服务器，供局域网内其他设备使用。
2. **web端配置 节点链接**：让树莓派自身能通过代理智能分流访问网络

#### 1.1准备工作

- **GitHub 参考地址**: https://github.com/vaxilu/x-ui
- **外置硬盘挂载点**: 确认外置硬盘已挂载，本文档示例路径为 `/docker`。

#### 1.2**创建部署目录：**

```
mkdir -p home/pi/docker/x-ui-data
cd  home/pi/docker/x-ui-data
```

#### 1.3创建docker-compose.yml：

```bash
nano docker-compose.yml
```

写入以下内容

```
services:
  x-ui:
    image: enwaiax/x-ui:latest
    container_name: x-ui
    restart: unless-stopped
    network_mode: host
    volumes:
      - ./db:/etc/x-ui/
      - ./cert:/root/cert/
    environment:
      - XUI_LOG_LEVEL=warn
      - XUI_LOG_FILE=/etc/x-ui/x-ui.log
```

#### 1.4启动服务：

```
docker-compose up -d
```

访问地址：http://树莓派IP:54321
默认账号：admin/admin

#### 1.5 web端配置核心

让树莓派本身可以通过代理进行智能分流，用于 `apt`、`curl` 等命令行工具。

1. **编辑配置文件**:

   web端点击设置----xray设置----右边粘贴json配置----重启面板**写入最终版 JSON 配置**: (此配置已包含智能分流规则和您提供的机场节点信息)

   ```JSON
   {
     "log": {
       "access": "",
       "error": "",
       "loglevel": "warning"
     },
     "dns": {
       "servers": [
         "1.1.1.1",
         "8.8.8.8"
       ]
     },
     "stats": {},
     "policy": {
       "system": {
         "statsOutboundUplink": true,
         "statsOutboundDownlink": true
       }
     },
     "inbounds": [
       {
         "tag": "socks-in",
         "port": 10808,
         "listen": "127.0.0.1",
         "protocol": "socks",
         "sniffing": {
           "enabled": true,
           "destOverride": ["http", "tls"]
         },
         "settings": {
           "auth": "noauth",
           "udp": true
         }
       },
       {
         "tag": "http-in",
         "port": 10809,
         "listen": "127.0.0.1",
         "protocol": "http",
         "sniffing": {
           "enabled": true,
           "destOverride": ["http", "tls"]
         },
         "settings": {}
       }
     ],
     "outbounds": [
       {
         "tag": "proxy",
         "protocol": "shadowsocks",
         "settings": {
           "servers": [
             {
               "address": "gheianygh.yangliq.com",
               "method": "aes-128-gcm",
               "ota": false,
               "password": "319600b1-309f-4275-be70-56c9e4f62358",
               "port": 31002,
               "level": 1
             }
           ]
         },
         "streamSettings": {
           "network": "tcp"
         },
         "mux": {
           "enabled": false
         }
       },
       {
         "tag": "direct",
         "protocol": "freedom",
         "settings": {}
       },
       {
         "tag": "block",
         "protocol": "blackhole",
         "settings": {
           "response": {
             "type": "http"
           }
         }
       }
     ],
     "routing": {
       "domainStrategy": "AsIs",
       "rules": [
         {
           "type": "field",
           "ip": [
             "geoip:private",
             "geoip:cn"
           ],
           "outboundTag": "direct"
         },
         {
           "type": "field",
           "domain": [
             "geosite:cn"
           ],
           "outboundTag": "direct"
         },
         {
           "type": "field",
           "domain": [
             "geosite:category-ads-all"
           ],
           "outboundTag": "block"
         },
         {
           "type": "field",
           "network": "tcp,udp",
           "outboundTag": "proxy"
         }
       ]
     }
   }
   ```

**如需修改节点,v2ray导出后，对应修改outbounds，出站规则即可**

#### 1.6配置系统全局代理

1. **编辑环境变量文件**:

   ```
   sudo nano /etc/environment
   ```

2. **在文件末尾添加以下内容**，将系统代理指向 V2Ray 提供的 HTTP 端口：

   ```bash
   http_proxy="http://127.0.0.1:10809"
   https_proxy="http://127.0.0.1:10809"
   no_proxy="localhost,127.0.0.1,::1,192.168.0.0/16,10.0.0.0/8,172.16.0.0/12,.local"
   ```

3. **更改docker代理为127.0.0.1:10809**

4. **重启树莓派使配置生效**:

   ```bash
   sudo reboot
   ```

   重启后，树莓派的命令行环境即可自动使用 V2Ray 进行智能分流代理。

#### **1.7（可选操作）Shell 配置文件配置全局局域网代理**

代理通常设置在用户的 Shell 初始化文件中。根据你的 Shell（`bash`），检查以下文件：

```bash
# 查看当前用户的环境配置文件
cat ~/.bashrc | grep -i proxy
cat ~/.bash_profile | grep -i proxy
cat ~/.profile | grep -i proxy

# 如果使用 zsh（默认不是，但可检查）
cat ~/.zshrc | grep -i proxy
```

**用 `nano` 编辑器打开文件：*

```bash
nano ~/.bashrc
```

找到这两行（你刚才用 `grep` 已经看到了它们）：

```bash
export http_proxy="http://192.168.124.20:10811"
export https_proxy="http://192.168.124.20:10811"
```

删除或注释掉它们：

- •**删除**：直接删除这两行。

- **注释**（推荐，可保留记录）：在行首加 `#`，变成：

  ```bash
  #export http_proxy="http://192.168.124.20:10811"
  #export https_proxy="http://192.168.124.20:10811"
  ```

#### 保存并退出：

- •按 `Ctrl + O` 保存 → 回车确认 → `Ctrl + X` 退出。

#### 立即生效：

```bash
source ~/.bashrc  # 重新加载配置
env | grep -i proxy  # 验证代理变量是否已消失
```

### 2. 皎月连安装（内网穿透）（docker部署）

**官网：[皎月连一键内网穿透](https://www.natpierce.cn/)**

#### 2.1创建部署目录：

```
mkdir -p home/pi/docker/jiaoyuelian
cd home/pi/docker/jiaoyuelian
```

#### 2.2创建docker-compose.yml：

1. **创建文件**： 在 `jiaoyuelian` 目录下，创建一个新的 `docker-compose.yml` 文件。

   ```bash
   nano docker-compose.yml
   ```

2. **粘贴内容**： 将以下内容完整复制并粘贴到文件中。

```
version: '3.8'
services:
  natpierce:
    image: xiyu505/natpierce:latest
    container_name: natpierce
    restart: always
    network_mode: host
    privileged: true
    volumes:
      - natpierce_data:/natpierce

volumes:
  natpierce_data:
```

#### 2.3启动服务：

```
docker-compose up -d
```

#### 2.4访问面板

访问地址：http://树莓派IP:33272
默认账号：zcjczy@126.com/带*1

### 3. Immich相册服务安装（docker部署）

#### 3.1. 准备工作

在开始之前，请确保完成以下基础准备。

##### 3.1.1. (前置要求) 确认64位操作系统

这是安装成功的**绝对前提**。请运行以下命令确认您的操作系统用户空间是64位的。

```bash
dpkg --print-architecture
```

**预期输出必须是 `arm64`**。如果输出是 `armhf`，则您需要停止安装，并为树莓派重装一个64位的操作系统。

文件格式ext4

```bash
df -Th
```

##### 3.1.2. 系统与工具更新

确保系统及软件包为最新状态，并安装 `git` 工具用于下载配置。

```bash
sudo apt update && sudo apt full-upgrade -y
sudo apt install git -y
```

##### 3.1.3. 准备外部存储

照片和数据库**必须**存放在外置硬盘（推荐SSD）上，而不是SD卡。

1. **连接硬盘**：将您的外置硬盘连接到树莓派的 USB 3.0 端口。

2. **确认挂载路径**：使用 `lsblk` 命令找到您的硬盘挂载点。本文档将以 `home/pi` 为例，**请在后续步骤中替换为您自己的真实路径**。

3. **创建数据目录**：

   ```bash
   # 请将 home/pi 替换为您的真实路径
   mkdir -p /home/pi/immich/photos
   #注意，数据库文件夹在sd卡上，因为外接硬盘是exFAT 或 NTFS格式。数据库要求ext4或其他支持linux权限的格式
   mkdir -p /home/pi/immich/database   
   
   # 授予当前pi用户读写权限
   sudo chown -R pi:pi /home/pi/immich/
   ```

#### 3.2. 获取并配置 Immich

##### 3.2.1. 下载官方配置文件

```bash
# 创建docker/immich目录
mkdir -p /home/pi/docker/immich
cd /home/pi/docker/immich
# 下载 docker-compose.yml 和 .env 模板
wget -O docker-compose.yml https://github.com/immich-app/immich/releases/latest/download/docker-compose.yml
wget -O .env https://github.com/immich-app/immich/releases/latest/download/example.env
```

##### 3.2.2. 配置 `.env` 文件

进入配置目录，并根据模板创建您的环境配置文件。

```bash
nano .env
```

在打开的编辑器中，修改以下关键内容：

```
# You can find documentation for all the supported env variables at https://immich.app/docs/install/environment-variables

# The location where your uploaded files are stored
UPLOAD_LOCATION=/home/pi/immich/photos

# The location where your database files are stored. Network shares are not supported for the database
DB_DATA_LOCATION=/home/pi/immich/database

# To set a timezone, uncomment the next line and change Etc/UTC to a TZ identifier from this list: https://en.wikipedia.org/wiki/List_of_tz_database_time_zones#List
# TZ=Etc/UTC
TZ=Asia/Shanghai
# The Immich version to use. You can pin this to a specific version like "v1.71.0"
IMMICH_VERSION=release

# Connection secret for postgres. You should change it to a random password
# Please use only the characters `A-Za-z0-9`, without special characters or spaces
DB_PASSWORD=postgres

# The values below this line do not need to be changed
###################################################################################
DB_USERNAME=postgres
DB_DATABASE_NAME=immich

VIPS_NOVECTOR=1
IMMICH__MACHINE__LEARNING__ENABLED=false 

```

更改四个设置`UPLOAD_LOCATION` `DB_DATA_LOCATION` `TZ=` `VIPS_NOVECTOR` 分别为照片地址，数据库地址，时区，向量指令集。

关键点`VIPS_NOVECTOR=1` 禁用VIPS指令，提高兼容性，解决exit 132问题

`IMMICH__MACHINE__LEARNING__ENABLED=false ` 关闭AI功能

修改完成后，按 `Ctrl+X` -> `Y` -> `Enter` 保存并退出。

#### 3.3. 最终的 `docker-compose.yml` 文件

1. **打开 `docker-compose.yml` 文件**：

   ```bash
   nano docker-compose.yml
   ```

2. **完整替换文件内容**： 请删除文件内的所有内容，然后将下面已经为您准备好的完整配置**全部复制**并粘贴进去。

   YAML

   ```bash
   #
   # WARNING: To install Immich, follow our guide: [https://immich.app/docs/install/docker-compose](https://immich.app/docs/install/docker-compose)
   #
   # Make sure to use the docker-compose.yml of the current release:
   #
   # [https://github.com/immich-app/immich/releases/latest/download/docker-compose.yml](https://github.com/immich-app/immich/releases/latest/download/docker-compose.yml)
   #
   # The compose file on main may not be compatible with the latest release.
   
   name: immich
   
   services:
     immich-server:
       container_name: immich_server
       image: ghcr.io/immich-app/immich-server:${IMMICH_VERSION:-release}
       # extends:
       #   file: hwaccel.transcoding.yml
       #   service: cpu # set to one of [nvenc, quicksync, rkmpp, vaapi, vaapi-wsl] for accelerated transcoding
       volumes:
         # Do not edit the next line. If you want to change the media storage location on your system, edit the value of UPLOAD_LOCATION in the .env file
         - ${UPLOAD_LOCATION}:/data
         - /etc/localtime:/etc/localtime:ro
       env_file:
         - .env
       ports:
         - '2283:2283'
       depends_on:
         - redis
         - database
       restart: always
       healthcheck:
         disable: false
   
     immich-machine-learning:
       container_name: immich_machine_learning
       # For hardware acceleration, add one of -[armnn, cuda, rocm, openvino, rknn] to the image tag.
       # Example tag: ${IMMICH_VERSION:-release}-cuda
       image: ghcr.io/immich-app/immich-machine-learning:${IMMICH_VERSION:-release}
       # extends: # uncomment this section for hardware acceleration - see [https://immich.app/docs/features/ml-hardware-acceleration](https://immich.app/docs/features/ml-hardware-acceleration)
       #   file: hwaccel.ml.yml
       #   service: cpu # set to one of [armnn, cuda, rocm, openvino, openvino-wsl, rknn] for accelerated inference - use the `-wsl` version for WSL2 where applicable
       volumes:
         - model-cache:/cache
       env_file:
         - .env
       restart: always
       healthcheck:
         disable: false
   
     redis:
       container_name: immich_redis
       image: docker.io/valkey/valkey:8-bookworm@sha256:a137a2b60aca1a75130022d6bb96af423fefae4eb55faf395732db3544803280
       healthcheck:
         test: redis-cli ping || exit 1
       restart: always
   
     database:
       container_name: immich_postgres
       image: ghcr.io/immich-app/postgres:14-vectorchord0.4.3-pgvectors0.2.0@sha256:32324a2f41df5de9efe1af166b7008c3f55646f8d0e00d9550c16c9822366b4a
       environment:
         POSTGRES_PASSWORD: ${DB_PASSWORD}
         POSTGRES_USER: ${DB_USERNAME}
         POSTGRES_DB: ${DB_DATABASE_NAME}
         POSTGRES_INITDB_ARGS: '--data-checksums'
         # Uncomment the DB_STORAGE_TYPE: 'HDD' var if your database isn't stored on SSDs
         # DB_STORAGE_TYPE: 'HDD'
       volumes:
         # Do not edit the next line. If you want to change the database storage location on your system, edit the value of DB_DATA_LOCATION in the .env file
         - ${DB_DATA_LOCATION}:/var/lib/postgresql/data
       shm_size: 128mb
       restart: always
   
   volumes:
     model-cache:
   ```

3. 按 `Ctrl+X` -> `Y` -> `Enter` 保存并退出。

#### 3.4. 启动与验证

##### 3.4.1. 启动服务

在 `immich/docker` 目录下，运行启动命令。

```bash
docker-compose up -d
```

Docker会使用精确的哈希值去拉取镜像。如果您之前已经手动拉取过，它会直接跳过下载并立即启动。

##### 3.4.2. 检查状态

等待几分钟，让所有服务完成初始化，然后运行以下命令查看状态：

```bash
docker-compose ps
```

您应该能看到所有服务都处于 `Up` 或 `running` 状态。

##### 3.4.3. 初次访问

在您的电脑浏览器中，访问 `http://<你的树莓派IP地址>:2283`。您会看到 Immich 的欢迎页面，请根据指引注册您的第一个管理员账户。

```bash
#管理员账户
zcjczy@126.com
612.
Jia-Hzz LI
```

##### 3.4.4.**停止并移除机器学习容器**

```

docker-compose stop immich-machine-learning
docker-compose rm -f immich-machine-learning
```

#### 3.5 手动配置AI模型

模型分为两类， CLIP 模型（智能搜索）和人脸识别模型。

##### 3.5.1准备工作

建立模型目录

```bash
#安装git-lfs
sudo apt-get install git-lfs

#总目录
cd home/pi/docker/immich  #此处存放.yml和.env文件
mkdir -p model-cache
#CLIP目录和人脸
cd model-cache
mkdir clip
mkdir facial-recognition
```

##### 3.5.2下载模型

```bash
#人脸识别模型 下载
cd /home/pi/docker/immich/model-cache/facial-recognition
git clone https://huggingface.co/immich-app/buffalo_l
#人脸识别模型 启用
cd buffalo_l
git lfs install
git lfs pull
#CLIP模型 下载
cd /home/pi/docker/immich/model-cache/clip
git clone https://huggingface.co/immich-app/XLM-Roberta-Large-Vit-B-16Plus 
#或更新更强的 nllb-clip-large-siglip__v1
#或原配ViT-B-32__openai
#CLIP模型 启用
cd XLM-Roberta-Large-Vit-B-16Plus
git lfs install
git lfs pul
```

##### 3.5.3 docker模型文件夹映射

```bash
#编辑.yml
nano docker-compose.yml
#更改
  immich-machine-learning:
    container_name: immich_machine_learning
    # For hardware acceleration, add one of -[armnn, cuda, rocm, openvino, rknn] to the image tag.
    # Example tag: ${IMMICH_VERSION:-release}-cuda
    image: ghcr.io/immich-app/immich-machine-learning:${IMMICH_VERSION:-release}
    # extends: # uncomment this section for hardware acceleration - see [https://immich.app/docs/features/ml-hardware-acceleration](https://immich.app/docs/features/ml-hardware-acceleration)
    #   file: hwaccel.ml.yml
    #   service: cpu # set to one of [armnn, cuda, rocm, openvino, openvino-wsl, rknn] for accelerated inference - use the `-wsl` version for WSL2 where applicable
    volumes:
      - ./model-cache:/cache
```

`model-cache:/cache` 改为`./model-cache:/cache` 

##### 3.5.4重启容器

```
docker-compose down
docker-compose up -d
```

##### 3.5.5web端改模型

web端设置修改

#### 3.5. 后续维护

##### 3.5.1. 如何更新 Immich

1. **访问镜像更新地址**：

   - `immich-server`: https://github.com/immich-app/immich/pkgs/container/immich-server
   - `immich-machine-learning`: https://github.com/immich-app/immich/pkgs/container/immich-machine-learning
   - `database` (postgres): [https://github.com/orgs/immich-app/packages/container/package/postgres](https://www.google.com/search?q=https://github.com/orgs/immich-app/packages/container/package/postgres)
   - `redis` (valkey): [https://hub.docker.com/_/valkey/tags](https://www.google.com/search?q=https://hub.docker.com/_/valkey/tags)

2. **查找新哈希值**： 按照我们之前实践过的方法，进入相应页面，找到新版本对应的 `linux/arm64` 的新哈希值。

3. **更新 `.yml` 文件**： 手动编辑 `docker-compose.yml` 文件，将旧的哈希值替换为新找到的哈希值。

4. **拉取并重启服务**： 在 `immich/docker` 目录下运行：

   ```bash
   docker-compose pull
   docker-compose up -d
   ```

##### 3.5.2. 如何备份

您的所有核心数据都在外置硬盘上。请务必定期备份以下两个目录：

- `/home/pi/immich/photos` (您的所有照片和视频)
- `/home/pi/immich/database` (您的所有相册信息、用户数据等)

### 4. Samba文件夹局域网共享

#### 步骤 1：安装 Samba 软件包

```
sudo apt update
sudo apt install samba samba-common-bin -y
```

#### 步骤 2：配置 Samba（设置共享目录和权限）

1. 1.备原始配置文件：

   ```
   sudo cp /etc/samba/smb.conf /etc/samba/smb.conf.bak
   ```

2. 2.编辑配置文件：

   ```
   sudo nano /etc/samba/smb.conf
   ```

3. 3.在文件**末尾**添加以下配置段（请将 `/media/pi/SNF` 替换为您想共享的实际路径）：

   ```
   # 我的SSD共享配置
   [SSD-Share]
      comment = Raspberry Pi SSD Share
      path = /media/pi/SNF
      browseable = yes
      read only = no
      guest ok = no
      create mask = 0777
      directory mask = 0777
      force user = pi
   ```

   - •`[SSD-Share]`：共享名称，在电脑上会看到这个名称。
   - •`path`：要共享的目录路径（**您SSD的挂载点**）。
   - •`read only = no`：允许读写。
   - •`guest ok = no`：禁止访客访问，需要密码。
   - •`force user = pi`：强制将所有访问权限映射给 `pi` 用户，避免权限问题。

#### 步骤 3：设置 Samba 用户密码

为系统用户 `pi` 设置一个专门的Samba访问密码：

```
sudo smbpasswd -a pi
```

按提示输入两次密码（**可以和系统登录密码不同，建议设置一下**）。

#### 步骤 4：重启 Samba 服务使配置生效

```
sudo systemctl restart smbd nmbd
```

#### 步骤 5：在 Windows 电脑上访问

1. 1.打开`文件资源管理器`，在地址栏输入：

   ```
   \\树莓派的IP地址
   ```

   例如：`\\192.168.124.8`

2. 2.在弹出的登录窗口中，用户名输入 `pi`，密码输入您刚才用 `smbpasswd` 设置的密码。

3. 3.勾选“记住我的凭据”，以后就能直接访问了。

#### 可能出现的权限问题

- 该目录可能属于 `root` 或其他用户，而当前用户（如 `pi`）没有访问权限。

- 检查权限的命令：

  ```
  ls -ld /home/pi/immich/photos/
  ```

  输出示例：

  ```
  drwx------ 26 dnsmasq pi 4096 Sep  4 13:48 /home/pi/immich/photos/
  ```

  1. 1所有权问题：
     - 所有者是 `dnsmasq` 用户（可能是错误配置）
     - 组是 `pi` 组
  2. 2.权限问题
     - `drwx------` 表示只有所有者（dnsmasq）有完全权限
     - 组用户（pi）和其他用户没有任何权限

  ##### 解决方案：

  1. 修改目录所有权（推荐）

  将目录所有者改为 `pi` 用户：

  ```
  sudo chown -R pi:pi /home/pi/immich/photos/
  ```

  2. 调整目录权限

  给予所有者完全权限，组用户读和执行权限：

  ```
  sudo chmod -R 750 /home/pi/immich/photos/
  ```

  或者如果需要其他用户也能访问（安全性较低）：

  ```
  sudo chmod -R 755 /home/pi/immich/photos/
  ```